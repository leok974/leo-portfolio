version: "3.9"
services:
  cloudflared:
    image: cloudflare/cloudflared:latest
    container_name: cloudflared
    # Safety assertion: Docker Compose will fail with clear error if token is missing
    # The :? syntax validates at compose-up time, preventing silent 502 failures
    command:
      [
        "tunnel",
        "--no-autoupdate",
        "run",
        "--token",
        "${CLOUDFLARE_TUNNEL_TOKEN:?[FATAL] CLOUDFLARE_TUNNEL_TOKEN not set. Run: $env:CLOUDFLARE_TUNNEL_TOKEN = (Get-Content .env.cloudflare | Select-String '^CLOUDFLARE_TUNNEL_TOKEN=').Line -replace '^CLOUDFLARE_TUNNEL_TOKEN=',''}",
      ]
    restart: unless-stopped
    environment:
      - TUNNEL_LOGLEVEL=info
      - CLOUDFLARE_TUNNEL_TOKEN=${CLOUDFLARE_TUNNEL_TOKEN}
    networks:
      - infra_net
    # No ports; tunnel is outbound-only. Must share infra_net with all services (nginx, backend, etc.)
    #
    # CRITICAL: This uses the SHARED production tunnel (08d5feee-f504-47a2-a1f2-b86564900991)
    # All public brands (ApplyLens, Portfolio, SiteAgents, TasteOS, etc.) route through this ONE tunnel.
    # Ingress rules are configured in Cloudflare Zero Trust dashboard.
    #
    # Setup:
    #   1. Load token: $env:CLOUDFLARE_TUNNEL_TOKEN = (Get-Content .env.cloudflare | Select-String "^CLOUDFLARE_TUNNEL_TOKEN=").Line -replace '^CLOUDFLARE_TUNNEL_TOKEN=',''
    #   2. Start: docker compose -f docker-compose.cloudflared.yml up -d
    #
    # Network aliases required for routing (defined in each service's compose file):
    #   - portfolio.int:80 → portfolio-nginx
    #   - portfolio-api.int:8000 → portfolio-backend
    #   - applylens.int:80 → applylens-nginx
    #   - applylens-api.int:8003 → applylens-backend
    #   - siteagent-ui.int:80 → siteagent-ui
    #   - siteagent-api.int:8000 → siteagent-api
    #
    # NEVER use a different tunnel UUID without updating ALL dependent services!
    # See INFRA_RUNBOOK.md for complete documentation.
    # No ports; tunnel is outbound-only. Must share infra_net with all services (nginx, backend, etc.)
    #
    # CRITICAL: This uses the SHARED production tunnel (08d5feee-f504-47a2-a1f2-b86564900991)
    # All public brands (ApplyLens, Portfolio, SiteAgents, TasteOS, etc.) route through this ONE tunnel.
    # Ingress rules are configured in Cloudflare Zero Trust dashboard.
    #
    # Network aliases required for routing:
    #   - portfolio.int:80 → portfolio-nginx
    #   - portfolio-api.int:8000 → portfolio-backend
    #   - applylens.int:80 → applylens-nginx
    #   - applylens-api.int:8003 → applylens-backend
    #   - siteagent-ui.int:80 → siteagent-ui
    #   - siteagent-api.int:8000 → siteagent-api
    #
    # NEVER use a different tunnel UUID without updating ALL dependent services!

networks:
  infra_net:
    external: true
    name: infra_net
