name: siteagent-nightly-pr

on:
  schedule:
    - cron: '27 3 * * *'   # 03:27 UTC nightly
  workflow_dispatch: {}

permissions:
  contents: write
  pull-requests: write

jobs:
  nightly-maintenance:
    runs-on: ubuntu-latest
    env:
      GITHUB_TOKEN: ${{ github.token }}
      GITHUB_REPO: ${{ github.repository }}
      SITEAGENT_HMAC_SECRET: ${{ secrets.SITEAGENT_HMAC_SECRET }}
      SITEAGENT_NIGHTLY: "1"
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r assistant_api/requirements.txt

      - name: Run maintenance tasks
        run: |
          echo "Running nightly maintenance tasks..."
          python -m assistant_api.cli run links.validate --safe || true
          python -m assistant_api.cli run media.optimize --safe --dry-run || true
          python -m assistant_api.cli run sitemap.media.update --safe || true

      - name: Check for changes
        id: changes
        run: |
          git config user.name "siteagent-bot"
          git config user.email "bot@users.noreply.github.com"

          if [ -n "$(git status --porcelain)" ]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "✅ Changes detected, will create PR"
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "ℹ️ No changes detected, skipping PR"
          fi

      - name: Commit changes to branch
        if: steps.changes.outputs.has_changes == 'true'
        run: |
          BRANCH="siteagent/nightly/$(date +%Y-%m-%d)"
          git checkout -b "$BRANCH"
          git add -A
          git commit -m "chore(siteAgent): nightly maintenance $(date +%Y-%m-%d)"
          git push origin "$BRANCH"
          echo "branch=$BRANCH" >> $GITHUB_ENV

      - name: Start backend (background)
        if: steps.changes.outputs.has_changes == 'true'
        run: |
          nohup python -m uvicorn assistant_api.main:app --host 127.0.0.1 --port 8010 > backend.log 2>&1 &
          sleep 5

          # Wait for backend to be ready
          for i in {1..30}; do
            if curl -sf http://127.0.0.1:8010/ready > /dev/null 2>&1; then
              echo "Backend is ready!"
              break
            fi
            sleep 1
          done

      - name: Create PR via backend
        if: steps.changes.outputs.has_changes == 'true'
        run: |
          # Prepare request body with dynamic branch
          BODY=$(cat <<EOF
          {"title":"chore(siteAgent): nightly maintenance $(date +%Y-%m-%d)","branch":"${{ env.branch }}","body":"Automated nightly maintenance tasks:\n\n- ✅ Links validation\n- ✅ Media optimization (dry-run)\n- ✅ Sitemap media update\n\nGenerated by siteagent-nightly-pr workflow."}
          EOF
          )

          # Generate HMAC signature
          SIGNATURE=$(echo -n "$BODY" | openssl dgst -sha256 -hmac "$SITEAGENT_HMAC_SECRET" | sed 's/^.* //')

          echo "Creating PR via backend..."
          RESPONSE=$(curl -sS -w "\n%{http_code}" -X POST "http://127.0.0.1:8010/agent/pr/open" \
            -H "Content-Type: application/json" \
            -H "X-SiteAgent-Signature: sha256=$SIGNATURE" \
            -d "$BODY")

          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          RESPONSE_BODY=$(echo "$RESPONSE" | sed '$d')

          echo "Response: $RESPONSE_BODY"

          if [ "$HTTP_CODE" -eq 200 ]; then
            echo "✅ PR created successfully!"
            echo "$RESPONSE_BODY" | jq -r '.url // empty'
          else
            echo "❌ PR creation failed!"
            cat backend.log
            exit 1
          fi

      - name: Show backend logs on failure
        if: failure()
        run: |
          echo "=== Backend logs ==="
          cat backend.log || echo "No backend logs found"
