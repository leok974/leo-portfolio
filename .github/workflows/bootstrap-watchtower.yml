name: Bootstrap Watchtower (Self-Hosted)
'on':
  workflow_dispatch:
    inputs:
      confirm:
        description: 'Type "bootstrap" to confirm deployment'
        required: true
        default: ''

jobs:
  bootstrap:
    runs-on: [self-hosted, prod, deploy]
    if: ${{ github.event.inputs.confirm == 'bootstrap' }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Verify runner environment
        run: |
          echo "ðŸ–¥ï¸  Runner hostname: $(hostname)"
          echo "ðŸ“‚ Working directory: $(pwd)"
          echo "ðŸ³ Docker version:"
          docker version | head -n 10
          echo "ðŸ”‘ Checking docker socket access..."
          docker ps | head -n 5
      
      - name: Create .env.production
        working-directory: deploy
        run: |
          echo "ðŸ“ Creating .env.production with secrets..."
          cat > .env.production << 'EOF'
          # Watchtower HTTP API Authentication
          WATCHTOWER_HTTP_API_TOKEN=${{ secrets.WATCHTOWER_HTTP_API_TOKEN }}
          
          # Figma MCP Integration
          FIGMA_PAT=${{ secrets.FIGMA_PAT }}
          FIGMA_TEAM_ID=${{ secrets.FIGMA_TEAM_ID }}
          FIGMA_TEMPLATE_KEY=${{ secrets.FIGMA_TEMPLATE_KEY }}
          
          # OpenAI Fallback (if configured)
          FALLBACK_API_KEY=${{ secrets.OPENAI_API_KEY }}
          EOF
          
          echo "âœ… .env.production created"
          echo "ðŸ” Verifying (masked):"
          grep -c "WATCHTOWER_HTTP_API_TOKEN" .env.production && echo "  âœ“ WATCHTOWER_HTTP_API_TOKEN present"
          grep -c "FIGMA_PAT" .env.production && echo "  âœ“ FIGMA_PAT present"
      
      - name: Pull latest images
        working-directory: deploy
        run: |
          echo "ðŸ“¥ Pulling latest Docker images..."
          docker compose -f docker-compose.portfolio-prod.yml pull
      
      - name: Deploy services
        working-directory: deploy
        run: |
          echo "ðŸš€ Starting services (Watchtower + Backend + Nginx)..."
          docker compose -f docker-compose.portfolio-prod.yml up -d
          
          echo "â³ Waiting for services to start..."
          sleep 10
      
      - name: Verify Watchtower running
        run: |
          echo "ðŸ” Checking Watchtower container..."
          if docker ps | grep -q watchtower; then
            echo "âœ… Watchtower container is running"
            docker ps | grep watchtower
          else
            echo "âŒ Watchtower container not found"
            exit 1
          fi
          
          echo ""
          echo "ðŸ“‹ Watchtower logs (last 20 lines):"
          docker logs portfolio-watchtower --tail=20 || docker logs watchtower --tail=20
      
      - name: Test Watchtower endpoint (local)
        run: |
          echo "ðŸ§ª Testing Watchtower HTTP API locally..."
          response=$(curl -sS -w "\n%{http_code}" -X POST http://127.0.0.1:8083/v1/update \
            -H "Authorization: Bearer ${{ secrets.WATCHTOWER_HTTP_API_TOKEN }}")
          
          http_code=$(echo "$response" | tail -n1)
          body=$(echo "$response" | head -n-1)
          
          echo "HTTP Status: $http_code"
          echo "Response: $body"
          
          if [ "$http_code" = "200" ] || [ "$http_code" = "204" ]; then
            echo "âœ… Watchtower local endpoint working"
          else
            echo "âš ï¸  Unexpected status code from Watchtower"
          fi
      
      - name: Test Watchtower endpoint (public)
        run: |
          echo "ðŸŒ Testing Watchtower public endpoint..."
          response=$(curl -sS -w "\n%{http_code}" -X POST https://api.leoklemet.com/ops/watchtower/update \
            -H "Authorization: Bearer ${{ secrets.WATCHTOWER_HTTP_API_TOKEN }}")
          
          http_code=$(echo "$response" | tail -n1)
          body=$(echo "$response" | head -n-1)
          
          echo "HTTP Status: $http_code"
          echo "Response: $body"
          
          if [ "$http_code" = "200" ] || [ "$http_code" = "204" ]; then
            echo "âœ… Watchtower public endpoint working"
          else
            echo "âŒ Watchtower public endpoint failed with status $http_code"
            exit 1
          fi
      
      - name: Verify backend health
        run: |
          echo "ðŸ¥ Checking backend health..."
          for i in {1..10}; do
            code=$(curl -sS -o /dev/null -w "%{http_code}" https://api.leoklemet.com/api/ready)
            if [ "$code" = "200" ]; then
              echo "âœ… Backend is healthy (attempt $i)"
              curl -sS https://api.leoklemet.com/api/ready
              exit 0
            fi
            echo "â³ Attempt $i/10: Backend returned $code, waiting..."
            sleep 5
          done
          echo "âš ï¸  Backend health check timeout"
          exit 1
      
      - name: Verify OpenAPI routes
        run: |
          echo "ðŸ“š Checking OpenAPI routes..."
          routes=$(curl -sS https://api.leoklemet.com/openapi.json | jq -r '.paths | keys[]' | head -20)
          echo "Available routes (first 20):"
          echo "$routes"
          
          echo ""
          echo "ðŸ” Checking for /ops/watchtower/update in nginx routes..."
          # Note: /ops/watchtower/update is nginx-only, won't appear in backend OpenAPI
      
      - name: Bootstrap summary
        if: success()
        run: |
          echo "ðŸŽ‰ ============================================"
          echo "ðŸŽ‰  BOOTSTRAP COMPLETE!"
          echo "ðŸŽ‰ ============================================"
          echo ""
          echo "âœ… Watchtower container running"
          echo "âœ… HTTP API endpoint accessible"
          echo "âœ… Backend healthy"
          echo "âœ… .env.production created with secrets"
          echo ""
          echo "ðŸ“‹ Next steps:"
          echo "  1. Run 'Redeploy Backend via Watchtower' workflow"
          echo "  2. Verify /api/dev/status endpoint works"
          echo "  3. Test dev overlay at /?dev_overlay=dev"
          echo ""
          echo "ðŸš€ One-click deployments now enabled!"
