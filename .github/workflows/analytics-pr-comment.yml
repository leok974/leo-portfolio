name: Analytics PR Comment

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  pull-requests: write

jobs:
  post-insight:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download latest analytics outputs
        uses: dawidd6/action-download-artifact@v6
        continue-on-error: true
        with:
          workflow: analytics-nightly.yml
          workflow_conclusion: success
          name: analytics-outputs
          path: analytics/outputs

      - name: Compose PR comment
        id: compose
        shell: bash
        run: |
          if [ -f analytics/outputs/insight-summary.md ]; then
            {
              echo "### 🧠 Analytics Insight"
              echo ""
              cat analytics/outputs/insight-summary.md
              echo ""
              echo "---"
              echo "*Auto-generated by [Analytics Nightly](https://github.com/${{ github.repository }}/actions/workflows/analytics-nightly.yml)*"
            } > pr-comment.md
          else
            {
              echo "### 🧠 Analytics Insight"
              echo ""
              echo "ℹ️ No nightly insight available yet."
              echo ""
              echo "The analytics pipeline runs nightly at 02:30 UTC. Check back after the next run for AI-generated insights from your SEO, Playwright, and metrics data."
              echo ""
              echo "**Manual run:**"
              echo '```bash'
              echo "python -m analytics.pipeline --window-days 7"
              echo '```'
            } > pr-comment.md
          fi

          # Read comment content
          COMMENT_BODY=$(cat pr-comment.md)

          # Save to file for sticky comment action
          echo "$COMMENT_BODY" > comment-body.txt

      - name: Post sticky comment
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          header: analytics-insight
          path: comment-body.txt
