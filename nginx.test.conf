server {
  listen 80;
  server_name _;

  root /usr/share/nginx/html;
  index index.html;

  # Security headers
  add_header Referrer-Policy "no-referrer" always;
  add_header X-Content-Type-Options "nosniff" always;
  add_header X-Frame-Options "DENY" always;
  add_header Permissions-Policy "camera=(), microphone=(), geolocation=()" always;

  # Content Security Policy (update hash if inline JSON-LD changes)
  set $csp "default-src 'self'; script-src 'self' 'sha256-agVi37OvPe9UtrYEB/KMHK3iJVAl08ok4xzbm7ry2JE='; style-src 'self'; img-src 'self' data:; font-src 'self'; connect-src 'self' http://localhost:8080 https://localhost:8443; object-src 'none'; base-uri 'self'; frame-ancestors 'none';";
  add_header Content-Security-Policy $csp always;

  # Health endpoint for Compose healthcheck
  location = /healthz { return 204; }

  # Service worker (if present)
  location = /sw.js {
    add_header Cache-Control "no-cache";
    try_files /sw.js =404;
  }

  # Immutable caching for built assets
  location ~* ^/(assets|fonts|img|images|css|js)/ {
    access_log off;
    add_header Cache-Control "public, max-age=31536000, immutable" always;
    try_files $uri =404;
  }

  # Never fallback for asset-like URLs
  location ~* \.(png|jpg|jpeg|gif|webp|svg|ico|json|txt|xml|map|woff2?|ttf|eot)$ {
    access_log off;
    add_header Cache-Control "public, max-age=31536000, immutable" always;
    try_files $uri =404;
  }

  # Short cache for project data (overrides generic json rule above via exact match)
  location = /projects.json {
    access_log off;
    add_header Cache-Control "public, max-age=300" always; # 5 minutes
    try_files $uri =404;
  }

  # API passthrough (no HTML fallback)
  location ^~ /api/ {
    try_files $uri =404;
  }

  # SPA fallback for page routes
  location / {
    try_files $uri $uri/ /index.html;
  }
}
