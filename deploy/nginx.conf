map $http_origin $allow_origin {
  default "";
  "~^https?://(leok974\.github\.io|app\.ledger-mind\.org|localhost(:\d+)?)$" $http_origin;
}

# Disable buffering for SSE based on Accept header
map $http_accept $sse {
  default 0;
  "~text/event-stream" 1;
}

limit_req_zone $binary_remote_addr zone=api_ql:10m rate=5r/s;

server {
  listen 80;
  server_name _;

  location /llm/health {
    proxy_pass http://backend:8000/llm/health;
    add_header Access-Control-Allow-Origin $allow_origin always;
    add_header Access-Control-Allow-Credentials true;
  }

  location /ready {
    proxy_pass http://backend:8000/ready;
    add_header Access-Control-Allow-Origin $allow_origin always;
    add_header Access-Control-Allow-Credentials true;
  }

  location /metrics {
    proxy_pass http://backend:8000/metrics;
    add_header Access-Control-Allow-Origin $allow_origin always;
    add_header Access-Control-Allow-Credentials true;
  }

  # Pass-through: map /status/* directly to backend /status/* (backend already exposes /status/summary root)
  location /status/ {
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_pass http://backend:8000/status/;
    add_header Access-Control-Allow-Origin $allow_origin always;
    add_header Access-Control-Allow-Credentials true;
  }

  # Preserve original URI for /api/* routes to avoid trailing slash issues
  location /api/ {
    limit_req zone=api_ql burst=20 nodelay;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_http_version 1.1;
    proxy_buffering off;
    proxy_read_timeout 300s;
    proxy_send_timeout 300s;
    proxy_pass http://backend:8000$request_uri;
    add_header X-Accel-Buffering no;
    add_header Access-Control-Allow-Origin $allow_origin always;
    add_header Access-Control-Allow-Credentials true;
  }

  location /chat/stream {
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header Connection '';
    proxy_http_version 1.1;
    proxy_buffering off;
    proxy_read_timeout 300s;
    proxy_send_timeout 300s;
    add_header X-Accel-Buffering no;
    add_header Cache-Control no-cache;
    add_header Access-Control-Allow-Origin $allow_origin always;
    add_header Access-Control-Allow-Credentials true;
    proxy_pass http://backend:8000$request_uri;
  }

  location /chat {
    proxy_pass http://backend:8000/chat;
    add_header Access-Control-Allow-Origin $allow_origin always;
    add_header Access-Control-Allow-Credentials true;
  }
}
