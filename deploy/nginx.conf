map $http_origin $allow_origin {
  default "";
  "~^https?://(leok974\.github\.io|app\.ledger-mind\.org|localhost(:\d+)?)$" $http_origin;
}

limit_req_zone $binary_remote_addr zone=api_ql:10m rate=5r/s;

server {
  listen 80;
  server_name _;

  location /llm/health {
    proxy_pass http://backend:8000/llm/health;
    add_header Access-Control-Allow-Origin $allow_origin always;
    add_header Access-Control-Allow-Credentials true;
  }

  location /ready {
    proxy_pass http://backend:8000/ready;
    add_header Access-Control-Allow-Origin $allow_origin always;
    add_header Access-Control-Allow-Credentials true;
  }

  location /metrics {
    proxy_pass http://backend:8000/metrics;
    add_header Access-Control-Allow-Origin $allow_origin always;
    add_header Access-Control-Allow-Credentials true;
  }

  location /api/ {
    limit_req zone=api_ql burst=20 nodelay;
    proxy_pass http://backend:8000/api/;
    add_header X-Accel-Buffering no;
    add_header Access-Control-Allow-Origin $allow_origin always;
    add_header Access-Control-Allow-Credentials true;
  }

  location /chat/stream {
    proxy_pass http://backend:8000/chat/stream;
    proxy_http_version 1.1;
    proxy_set_header Connection '';
    proxy_buffering off;
    add_header X-Accel-Buffering no;
    add_header Cache-Control no-cache;
    add_header Access-Control-Allow-Origin $allow_origin always;
    add_header Access-Control-Allow-Credentials true;
  }

  location /chat {
    proxy_pass http://backend:8000/chat;
    add_header Access-Control-Allow-Origin $allow_origin always;
    add_header Access-Control-Allow-Credentials true;
  }
}
