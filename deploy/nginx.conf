include /etc/nginx/mime.types;
limit_req_zone $binary_remote_addr zone=api_rl:10m rate=30r/m;
limit_conn_zone $binary_remote_addr zone=sse_conn:10m;

# Map upstream error status codes to a warming flag (for status summary interception)
map $upstream_status $warm {
  default 0;
  000 1;  # no upstream / connection refused
  502 1;
  503 1;
  504 1;
}

# Centralized CORS allow list (defined at http block scope)
map $http_origin $cors_ok {
  default 0;
  '~^https://leok974\.github\.io$' 1;
  '~^https://app\.ledger-mind\.org$' 1;
}

server {
  listen 80;
  server_name _;

  # Root SPA assets
  root /usr/share/nginx/html;
  index index.html;

  # Sentinel header to prove live config version when bind-mounted
  add_header X-Config "v3" always;

    # --- Security headers (drift-guarded by tests/e2e/security-headers.spec.ts) ---
    add_header X-Frame-Options "DENY" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header Referrer-Policy "no-referrer" always;
    add_header Permissions-Policy "camera=(), microphone=(), geolocation=()" always;
  # CSP policy (single source of truth). Build step substitutes sha256 hash token.
  # Tightened connect-src: enumerate only required backends (self + assistant API host if served from GitHub Pages)
  # Added upgrade-insecure-requests for universal HTTPS enforcement behind Cloudflare/TLS.
  set $csp_policy "default-src 'self'; img-src 'self' data: blob:; font-src 'self' data:; connect-src 'self' https://assistant.ledger-mind.org; script-src 'self' 'sha256-agVi37OvPe9UtrYEB/KMHK3iJVAl08ok4xzbm7ry2JE='; style-src 'self'; object-src 'none'; base-uri 'self'; frame-ancestors 'none'; upgrade-insecure-requests;";
  add_header Content-Security-Policy "$csp_policy" always;
  # (Rely on mime.types include; do not override default_type so JS/CSS pick correct MIME)
  # Manifest explicit handler (global mime map already included at top)
  location = /site.webmanifest { default_type application/manifest+json; try_files $uri =404; }

  # 1) Never fall back to HTML for fingerprinted / static assets under /assets/
  # (No ^~ so that a more specific regex (e.g. webmanifest) can still win.)
  location /assets/ {
    add_header X-Config "v3" always;
    add_header Cache-Control "public, max-age=31536000, immutable" always;
    # Security headers duplicated due to add_header override semantics
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-Frame-Options "DENY" always;
    add_header Referrer-Policy "no-referrer" always;
    add_header Permissions-Policy "camera=(), microphone=(), geolocation=()" always;
  add_header Content-Security-Policy "$csp_policy" always;
    try_files $uri =404;
  }

  # (optional) legacy fonts dir (retain long-cache semantics if still used)
  location ^~ /fonts/ {
    add_header Cache-Control "public, max-age=31536000, immutable" always;
    try_files $uri =404;
  }

  # 2) Static file extensions (exclude html to keep page routes separate)
  location ~* \.(?:js|mjs|cjs|css|woff2?|webp|png|jpe?g|gif|svg|ico|json|map)$ {
    add_header X-Config "v3" always;
    add_header Cache-Control "public, max-age=31536000, immutable" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-Frame-Options "DENY" always;
    add_header Referrer-Policy "no-referrer" always;
    add_header Permissions-Policy "camera=(), microphone=(), geolocation=()" always;
  add_header Content-Security-Policy "$csp_policy" always;
    try_files $uri =404;
  }

  # 2b) Ensure webmanifest gets correct MIME + caching (root or assets path)
  location ~* \.webmanifest$ {
    add_header X-Config "v3" always;
    default_type application/manifest+json;
    add_header Cache-Control "public, max-age=31536000, immutable" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-Frame-Options "DENY" always;
    add_header Referrer-Policy "no-referrer" always;
    add_header Permissions-Policy "camera=(), microphone=(), geolocation=()" always;
  add_header Content-Security-Policy "$csp_policy" always;
    try_files $uri =404;
  }

  # 2c) Project data JSON (short-lived cache; changes more frequently than static assets)
  location = /projects.json {
    add_header X-Config "v3" always;
    add_header Cache-Control "public, max-age=300" always; # 5 minutes
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-Frame-Options "DENY" always;
    add_header Referrer-Policy "no-referrer" always;
    add_header Permissions-Policy "camera=(), microphone=(), geolocation=()" always;
  add_header Content-Security-Policy "$csp_policy" always;
    try_files $uri =404;
  }

  # /agent â†’ FastAPI backend (place BEFORE SPA fallback)
  location ^~ /agent/ {
    add_header          X-Served-By "portfolio-nginx" always;
    proxy_pass          http://ai-finance-api.int:8000;
    proxy_http_version  1.1;
    proxy_set_header    Host                $host;
    proxy_set_header    X-Real-IP           $remote_addr;
    proxy_set_header    X-Forwarded-For     $proxy_add_x_forwarded_for;
    proxy_set_header    X-Forwarded-Proto   $scheme;
    proxy_set_header    Connection          "";
    # Preserve authentication headers
    proxy_set_header    X-SiteAgent-Signature $http_x_siteagent_signature;
    proxy_set_header    Cf-Access-Jwt-Assertion $http_cf_access_jwt_assertion;
    proxy_set_header    CF-Access-Client-Id $http_cf_access_client_id;
    proxy_set_header    CF-Access-Client-Secret $http_cf_access_client_secret;
    proxy_read_timeout  300s;
    proxy_send_timeout  300s;
    proxy_buffering     off;
    client_max_body_size 16m;
    add_header          X-Accel-Route "agent" always;
    add_header          Cache-Control "no-store" always;
  }

  # 3) Page routes + index fallback (no immutable cache)
  location / {
    add_header X-Config "v3" always;
    add_header Cache-Control "no-cache";
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-Frame-Options "DENY" always;
    add_header Referrer-Policy "no-referrer" always;
    add_header Permissions-Policy "camera=(), microphone=(), geolocation=()" always;
  add_header Content-Security-Policy "$csp_policy" always;
    try_files $uri $uri/ /index.html;
  }

  # API proxy (preserve URI)
  location /api/ {
    limit_req zone=api_rl burst=15 nodelay;
    proxy_set_header Host               $host;
    proxy_set_header X-Real-IP          $remote_addr;
    proxy_set_header X-Forwarded-For    $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto  $scheme;
    proxy_http_version 1.1;
    proxy_buffering off;
    proxy_read_timeout 300s;
    proxy_send_timeout 300s;
    proxy_pass http://ai-finance-api.int:8000$request_uri;
  }

  # Explicit mapping for RAG ingest to avoid SPA fallback and reuse API proxy settings
  location = /api/rag/ingest {
    limit_req zone=api_rl burst=15 nodelay;
    proxy_set_header Host               $host;
    proxy_set_header X-Real-IP          $remote_addr;
    proxy_set_header X-Forwarded-For    $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto  $scheme;
    proxy_http_version 1.1;
    proxy_buffering off;
    proxy_read_timeout 300s;
    proxy_send_timeout 300s;
    proxy_pass http://ai-finance-api.int:8000/api/rag/ingest;
  }

  # Compatibility shim: remap /api/chat -> /chat (backend expects unprefixed path)
  location = /api/chat {
    proxy_set_header Host               $host;
    proxy_set_header X-Real-IP          $remote_addr;
    proxy_set_header X-Forwarded-For    $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto  $scheme;
    proxy_http_version 1.1;
    proxy_buffering off;
  # Allow long-running completions (non-SSE) up to 5 minutes
  proxy_read_timeout 300s;
  proxy_send_timeout 300s;
    proxy_pass http://ai-finance-api.int:8000/chat;
  }

  # Compatibility shim: remap /api/chat/stream -> /chat/stream (SSE, disable buffering)
  location = /api/chat/stream {
    limit_conn sse_conn 1;
    proxy_set_header Host               $host;
    proxy_set_header X-Real-IP          $remote_addr;
    proxy_set_header X-Forwarded-For    $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto  $scheme;
    proxy_http_version 1.1;
    proxy_buffering off;
  # Keep streaming connection effectively unlimited for long chats
  proxy_read_timeout 24h;
  proxy_send_timeout 24h;
    proxy_pass http://ai-finance-api.int:8000/chat/stream;
  }

  # Streaming SSE (direct path)
  location /chat/stream {
    limit_conn sse_conn 1;
    proxy_set_header Host               $host;
    proxy_set_header X-Real-IP          $remote_addr;
    proxy_set_header X-Forwarded-For    $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto  $scheme;
    proxy_http_version 1.1;
    proxy_buffering off;
  proxy_read_timeout 24h;
  proxy_send_timeout 24h;
    proxy_pass http://ai-finance-api.int:8000$request_uri;
  }

  # Health & diagnostics passthrough
  location /llm/ { proxy_pass http://ai-finance-api.int:8000$request_uri; }
  location /ready { proxy_pass http://ai-finance-api.int:8000/ready; }
  location /metrics { proxy_pass http://ai-finance-api.int:8000/metrics; }

  # $cors_ok available from http-level map

  # Preferred path: /api/status/* -> backend /status/* (rewrite) with CORS
  # Special case /api/status/summary for warming interception
  location = /api/status/summary {
    proxy_intercept_errors on;
    proxy_set_header Host               $host;
    proxy_set_header X-Real-IP          $remote_addr;
    proxy_set_header X-Forwarded-For    $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto  $scheme;
    proxy_pass http://ai-finance-api.int:8000/status/summary;
    add_header X-Status-Path api always;
    if ($cors_ok) {
      add_header Access-Control-Allow-Origin $http_origin always;
      add_header Vary Origin always;
    }
    add_header Cache-Control "no-store, no-cache, must-revalidate, max-age=0" always;
    error_page 500 502 503 504 = @warming_json;
  }

  location /api/status/ {
    rewrite ^/api/status/(.*)$ /status/$1 break;
    proxy_set_header Host               $host;
    proxy_set_header X-Real-IP          $remote_addr;
    proxy_set_header X-Forwarded-For    $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto  $scheme;
    proxy_pass http://ai-finance-api.int:8000;
    add_header X-Status-Path api always;
    # CORS on all outcomes
    if ($cors_ok) {
      add_header Access-Control-Allow-Origin $http_origin always;
      add_header Vary Origin always;
    }
    if ($request_method = OPTIONS) {
      add_header Access-Control-Allow-Origin $http_origin always;
      add_header Access-Control-Allow-Methods "GET,OPTIONS" always;
      add_header Access-Control-Allow-Headers "Content-Type" always;
      return 204;
    }
    add_header Cache-Control "no-store, no-cache, must-revalidate, max-age=0" always;
  }

  # Legacy direct /status/* passthrough (normalize single CORS header)
  location /status/ {
    proxy_set_header Host               $host;
    proxy_set_header X-Real-IP          $remote_addr;
    proxy_set_header X-Forwarded-For    $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto  $scheme;
    proxy_pass http://ai-finance-api.int:8000$request_uri;
    add_header X-Status-Path legacy always;
    # Remove upstream duplicates to emit one canonical header set
    proxy_hide_header Access-Control-Allow-Origin;
    proxy_hide_header Vary;
    if ($cors_ok) {
      add_header Access-Control-Allow-Origin $http_origin always;
      add_header Vary Origin always;
    }
    if ($request_method = OPTIONS) {
      add_header Access-Control-Allow-Origin $http_origin always;
      add_header Access-Control-Allow-Methods "GET,OPTIONS" always;
      add_header Access-Control-Allow-Headers "Content-Type" always;
      return 204;
    }
    add_header Cache-Control "no-store, no-cache, must-revalidate, max-age=0" always;
  }

  # Internal warming JSON response (served when upstream summary not yet ready)
  location @warming_json {
    add_header X-Status-Path api always;
    if ($cors_ok) {
      add_header Access-Control-Allow-Origin $http_origin always;
      add_header Vary Origin always;
    }
    add_header Content-Type application/json;
    add_header Cache-Control "no-store, no-cache, must-revalidate, max-age=0";
    return 200 '{"ok":false,"ready":false,"llm":{"path":"warming"},"rag":{"ok":true}}';
  }
}
