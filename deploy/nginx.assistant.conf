# Unified assistant.ledger-mind.org: SPA at /, API at /api/
# Copy or include this in your Docker/nginx setup (e.g., mount to /etc/nginx/conf.d/default.conf)

# upstreams
# For local dev: backend:8000 (Docker Compose service name)
# For production: ai-finance-api.int:8000 (production service hostname)
upstream backend_api {
    server backend:8000;  # Change to ai-finance-api.int:8000 for production
    keepalive 16;
}

server {
  listen 80 default_server;
  server_name assistant.ledger-mind.org;

  # Inject build identification (set BUILD_ID env → docker ARG → envsubst or baked sed replace in CI)
  add_header X-Build-ID "$BUILD_ID" always;

  # Static SPA build
  root /usr/share/nginx/html;
  index index.html;

  # Cache hashed assets aggressively
  location ~* \.(?:js|css|png|jpg|jpeg|gif|svg|webp|ico|woff2?)$ {
    access_log off;
    expires 30d;
    add_header Cache-Control "public, immutable";
    try_files $uri =404;
  }

  # /agent → FastAPI backend (place BEFORE SPA fallback)
  location ^~ /agent/ {
    proxy_pass          http://backend_api;
    proxy_http_version  1.1;
    proxy_set_header    Host                $host;
    proxy_set_header    X-Real-IP           $remote_addr;
    proxy_set_header    X-Forwarded-For     $proxy_add_x_forwarded_for;
    proxy_set_header    X-Forwarded-Proto   $scheme;
    proxy_set_header    Connection          "";
    # Preserve authentication headers
    proxy_set_header    X-SiteAgent-Signature $http_x_siteagent_signature;
    proxy_set_header    Cf-Access-Jwt-Assertion $http_cf_access_jwt_assertion;
    proxy_set_header    CF-Access-Client-Id $http_cf_access_client_id;
    proxy_set_header    CF-Access-Client-Secret $http_cf_access_client_secret;
    proxy_read_timeout  300s;
    proxy_send_timeout  300s;
    proxy_buffering     off;
    client_max_body_size 16m;
    add_header          X-Accel-Route "agent" always;
    add_header          Cache-Control "no-store" always;
  }

  # SPA history fallback
  location / {
    try_files $uri /index.html;
  }

  # API proxy (FastAPI backend service name 'backend')
  location /api/ {
    proxy_pass http://backend_api/; # using upstream
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    add_header X-Build-ID "$BUILD_ID" always;
  }

  # Direct health shortcuts (optional convenience)
  location = /ready { proxy_pass http://backend_api/ready; }
  location = /status/summary { proxy_pass http://backend_api/status/summary; }
  location = /_up { return 204; }
}
