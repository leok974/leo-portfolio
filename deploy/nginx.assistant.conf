# Unified assistant.ledger-mind.org: SPA at /, API at /api/
# Copy or include this in your Docker/nginx setup (e.g., mount to /etc/nginx/conf.d/default.conf)
server {
  listen 80 default_server;
  server_name assistant.ledger-mind.org;

  # Inject build identification (set BUILD_ID env → docker ARG → envsubst or baked sed replace in CI)
  add_header X-Build-ID "$BUILD_ID" always;

  # Static SPA build
  root /usr/share/nginx/html;
  index index.html;

  # Cache hashed assets aggressively
  location ~* \.(?:js|css|png|jpg|jpeg|gif|svg|webp|ico|woff2?)$ {
    access_log off;
    expires 30d;
    add_header Cache-Control "public, immutable";
    try_files $uri =404;
  }

  # SPA history fallback
  location / {
    try_files $uri /index.html;
  }

  # API proxy (FastAPI backend service name 'backend')
  location /api/ {
    proxy_pass http://backend:8001/; # adjust port if container differs
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    add_header X-Build-ID "$BUILD_ID" always;
  }

  # Direct health shortcuts (optional convenience)
  location = /ready { proxy_pass http://backend:8001/ready; }
  location = /status/summary { proxy_pass http://backend:8001/status/summary; }
  location = /_up { return 204; }
}
