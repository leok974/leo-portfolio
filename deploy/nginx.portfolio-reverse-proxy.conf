# Nginx Reverse Proxy Configuration for Portfolio (Image-Based Deployment)
#
# This config is for the REVERSE PROXY container (nginx/caddy/traefik) that routes
# traffic to the portfolio container. The portfolio container itself uses
# nginx.portfolio-static.conf (minimal config for static files).
#
# ARCHITECTURE:
#   Internet → Cloudflare/CDN → Reverse Proxy (THIS CONFIG) → portfolio:80 (static files)
#                                                           → siteagent:8001 (API)
#
# SAME-ORIGIN PATTERN:
#   All requests to assistant.ledger-mind.org are handled by this reverse proxy:
#   - Static files: proxied to portfolio container
#   - API calls: proxied to siteagent backend
#   Result: No CORS issues (all requests from same origin)

upstream portfolio_backend {
    server portfolio:80;
    keepalive 16;
}

upstream siteagent_backend {
    server siteagent:8001;
    keepalive 8;
}

# HTTP server (redirect to HTTPS)
server {
    listen 80;
    listen [::]:80;
    server_name assistant.ledger-mind.org;

    # Allow Let's Encrypt challenges
    location /.well-known/acme-challenge/ {
        root /var/www/certbot;
    }

    # Redirect everything else to HTTPS
    location / {
        return 301 https://$server_name$request_uri;
    }
}

# HTTPS server
server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    server_name assistant.ledger-mind.org;

    # SSL Configuration
    ssl_certificate /etc/letsencrypt/live/assistant.ledger-mind.org/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/assistant.ledger-mind.org/privkey.pem;
    ssl_session_timeout 1d;
    ssl_session_cache shared:SSL:50m;
    ssl_session_tickets off;

    # Modern SSL configuration
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers 'ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384';
    ssl_prefer_server_ciphers off;

    # Security headers
    add_header Strict-Transport-Security "max-age=63072000; includeSubDomains; preload" always;
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;

    # Logging
    access_log /var/log/nginx/portfolio-access.log combined;
    error_log /var/log/nginx/portfolio-error.log warn;

    # Max upload size
    client_max_body_size 20M;

    # =================================================================
    # SAME-ORIGIN API PROXIES
    # These MUST come BEFORE location / to match first
    # =================================================================

    # Chat endpoint (JSON responses)
    location /chat {
        proxy_pass http://siteagent_backend/chat;
        proxy_http_version 1.1;

        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }

    # Chat streaming endpoint (Server-Sent Events)
    location /chat/stream {
        proxy_pass http://siteagent_backend/chat/stream;
        proxy_http_version 1.1;

        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Connection '';

        # CRITICAL: Disable buffering for SSE
        proxy_buffering off;
        proxy_request_buffering off;
        proxy_cache off;

        # Long timeout for streaming
        proxy_connect_timeout 60s;
        proxy_send_timeout 3600s;
        proxy_read_timeout 3600s;

        # Prevent nginx from timing out idle connections
        chunked_transfer_encoding on;
    }

    # Resume generation endpoint
    location /resume/ {
        proxy_pass http://siteagent_backend/resume/;
        proxy_http_version 1.1;

        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        proxy_connect_timeout 30s;
        proxy_send_timeout 30s;
        proxy_read_timeout 30s;
    }

    # RAG API endpoints
    location /api/ {
        proxy_pass http://siteagent_backend/api/;
        proxy_http_version 1.1;

        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }

    # LLM diagnostic endpoints
    location ~ ^/llm/(models|latency|diag|grounding) {
        proxy_pass http://siteagent_backend;
        proxy_http_version 1.1;

        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Health endpoints
    location ~ ^/(ready|status/summary|metrics) {
        proxy_pass http://siteagent_backend;
        proxy_http_version 1.1;

        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }

    # =================================================================
    # PORTFOLIO STATIC FILES
    # This MUST come last (most generic)
    # =================================================================

    # Portfolio container (static files)
    location / {
        proxy_pass http://portfolio_backend;
        proxy_http_version 1.1;

        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # Short timeout for static files
        proxy_connect_timeout 10s;
        proxy_send_timeout 10s;
        proxy_read_timeout 10s;

        # Cache static assets
        proxy_cache_bypass $http_pragma $http_authorization;
        proxy_no_cache $http_pragma $http_authorization;
    }

    # Explicit asset caching (optional - portfolio container already caches)
    location ~* ^/assets/.*\.(css|js|jpg|jpeg|png|gif|svg|webp|woff|woff2|ttf|eot|ico)$ {
        proxy_pass http://portfolio_backend;
        proxy_http_version 1.1;

        proxy_set_header Host $host;

        # Cache on reverse proxy level (optional)
        proxy_cache_valid 200 30d;
        add_header Cache-Control "public, max-age=2592000, immutable";
    }
}

# =================================================================
# ALTERNATIVE: WITHOUT SSL (if using Cloudflare Tunnel)
# =================================================================

# If using Cloudflare Tunnel, you don't need SSL in nginx:
# Tunnel handles TLS termination, nginx just listens on HTTP

# server {
#     listen 80;
#     listen [::]:80;
#     server_name assistant.ledger-mind.org;
#
#     # ... same proxy_pass configurations as above ...
# }

# =================================================================
# TROUBLESHOOTING NOTES
# =================================================================

# SYMPTOM: 502 Bad Gateway
# CAUSE: Nginx can't reach backend containers
# FIX: Ensure all containers on same Docker network:
#   docker network inspect web
#   # Should show: portfolio, siteagent, nginx

# SYMPTOM: API calls fail with CORS
# CAUSE: API proxy not working
# FIX: Verify location order (API locations BEFORE location /)
#   Test: curl http://localhost/chat (should hit siteagent)

# SYMPTOM: SSE streaming stops after 60s
# CAUSE: proxy_buffering not disabled
# FIX: Add to /chat/stream location:
#   proxy_buffering off;
#   proxy_request_buffering off;

# SYMPTOM: nginx -t fails
# CAUSE: Syntax error
# FIX: Check quotes, semicolons, braces
#   docker exec nginx-container nginx -t

# SYMPTOM: Changes not applied
# CAUSE: Nginx not reloaded
# FIX: docker exec nginx-container nginx -s reload
