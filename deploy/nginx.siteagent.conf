include /etc/nginx/mime.types;
limit_req_zone $binary_remote_addr zone=api_rl:10m rate=30r/m;
limit_conn_zone $binary_remote_addr zone=sse_conn:10m;

# Generate a simple nonce from request_id (good enough for CSP)
map $request_id $csp_nonce {
  default $request_id;
}

# Map upstream error status codes to a warming flag (for status summary interception)
map $upstream_status $warm {
  default 0;
  000 1;  # no upstream / connection refused
  502 1;
  503 1;
  504 1;
}

# Centralized CORS allow list (defined at http block scope)
map $http_origin $cors_ok {
  default 0;
  '~^https://siteagents\.app$' 1;
  '~^https://www\.siteagents\.app$' 1;
}

server {
  listen 80;
  server_name _;

  # Root SPA assets (SiteAgent UI)
  root /usr/share/nginx/html;
  index index.html;

  # Sentinel header to prove live config version when bind-mounted
  add_header X-Config "v4-siteagent" always;

  # Replace CSP nonce placeholder in HTML
  sub_filter_once off;
  sub_filter_types text/html;
  sub_filter "__CSP_NONCE__" "$csp_nonce";

  # --- Security headers ---
  add_header X-Frame-Options "DENY" always;
  add_header X-Content-Type-Options "nosniff" always;
  add_header Referrer-Policy "strict-origin-when-cross-origin" always;
  add_header Permissions-Policy "camera=(), microphone=(), geolocation=()" always;

  # CSP policy with nonce and strict-dynamic (allows CF analytics)
  # NOTE: Currently not appearing in response headers - under investigation
  add_header Content-Security-Policy "default-src 'self'; base-uri 'self'; frame-ancestors 'self'; object-src 'none'; script-src 'self' 'nonce-$csp_nonce' https://static.cloudflareinsights.com 'strict-dynamic'; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:; font-src 'self' data:; connect-src 'self' https://api.siteagents.app https://agent.siteagents.app; form-action 'self'; upgrade-insecure-requests" always;

  # Health check endpoint
  location = /healthz {
    access_log off;
    add_header Content-Type text/plain;
    return 200 "ok\n";
  }

  # Manifest explicit handler
  location = /site.webmanifest {
    default_type application/manifest+json;
    try_files $uri =404;
  }

  # Static assets under /assets/ - long cache
  location /assets/ {
    add_header X-Config "v4-siteagent" always;
    add_header Cache-Control "public, max-age=31536000, immutable" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-Frame-Options "DENY" always;
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;
    add_header Permissions-Policy "camera=(), microphone=(), geolocation=()" always;
    try_files $uri =404;
  }

  # Static file extensions (exclude html) - long cache
  location ~* \.(?:js|mjs|cjs|css|woff2?|webp|png|jpe?g|gif|svg|ico|json|map)$ {
    add_header X-Config "v4-siteagent" always;
    add_header Cache-Control "public, max-age=31536000, immutable" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-Frame-Options "DENY" always;
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;
    add_header Permissions-Policy "camera=(), microphone=(), geolocation=()" always;
    try_files $uri =404;
  }

  # Webmanifest - correct MIME + caching
  location ~* \.webmanifest$ {
    add_header X-Config "v4-siteagent" always;
    default_type application/manifest+json;
    add_header Cache-Control "public, max-age=31536000, immutable" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-Frame-Options "DENY" always;
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;
    add_header Permissions-Policy "camera=(), microphone=(), geolocation=()" always;
    try_files $uri =404;
  }

  # robots.txt
  location = /robots.txt {
    add_header X-Config "v4-siteagent" always;
    add_header Cache-Control "public, max-age=3600" always;
    try_files $uri =404;
  }

  # sitemap.xml
  location = /sitemap.xml {
    add_header X-Config "v4-siteagent" always;
    add_header Cache-Control "public, max-age=3600" always;
    try_files $uri =404;
  }

  # Favicon
  location = /favicon.ico {
    add_header X-Config "v4-siteagent" always;
    add_header Cache-Control "public, max-age=86400" always;
    try_files $uri =404;
  }

  location = /favicon.svg {
    add_header X-Config "v4-siteagent" always;
    add_header Cache-Control "public, max-age=86400" always;
    try_files $uri =404;
  }

  # HTML files - no cache for SPA
  location ~* \.html$ {
    add_header X-Config "v4-siteagent" always;
    add_header Cache-Control "no-cache" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-Frame-Options "DENY" always;
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;
    add_header Permissions-Policy "camera=(), microphone=(), geolocation=()" always;
    try_files $uri =404;
  }

  # Root and SPA fallback
  location / {
    add_header X-Config "v4-siteagent" always;
    add_header Cache-Control "no-cache" always;
    try_files $uri $uri/ /index.html;
  }
}
