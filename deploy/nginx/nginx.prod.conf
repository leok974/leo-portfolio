# Production Nginx config (tight CSP, no inline allowances)
# Assumes all inline <script> and <style> removed.

limit_req_zone $binary_remote_addr zone=api_rl:10m rate=30r/m;
limit_conn_zone $binary_remote_addr zone=sse_conn:10m;

# Reuse existing CORS origin map pattern if desired (optional here)
map $http_origin $cors_ok { default 0; '~^https://leok974\.github\.io$' 1; '~^https://app\.ledger-mind\.org$' 1; }

server {
  listen 80;
  server_name _;
  root /usr/share/nginx/html;
  index index.html;

  # SECURITY HEADERS (prod)
  add_header Content-Security-Policy "\n    default-src 'self';\n    base-uri 'self';\n    object-src 'none';\n    frame-ancestors 'none';\n    form-action 'self';\n    img-src 'self' data: blob:;\n    font-src 'self' data:;\n    style-src 'self';\n    script-src 'self' 'sha256-67tx3DLPvgnRJFbfO8oOOFqf4V01LRbz7cbm24J5AYs=';\n    connect-src 'self' http://localhost:8080 https://localhost:8443;\n  " always;
  add_header Referrer-Policy "no-referrer" always;
  add_header X-Content-Type-Options "nosniff" always;
  add_header X-Frame-Options "DENY" always;
  add_header Permissions-Policy "camera=(), microphone=(), geolocation=()" always;
  # add_header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload" always; # enable only under HTTPS

  # Explicit MIME reinforcement (in case base image mime.types misses entries)
  types {
    text/css                           css;
    application/javascript             js mjs;
    font/woff2                         woff2;
    font/woff                          woff;
    image/webp                         webp;
    image/avif                         avif;
    application/manifest+json          webmanifest manifest;
  }
  location = /site.webmanifest { default_type application/manifest+json; try_files $uri =404; }

  # Long-cache immutable hashed assets / directories
  location ^~ /assets/ { add_header Cache-Control "public, max-age=31536000, immutable"; try_files $uri =404; }
  location ^~ /fonts/  { add_header Cache-Control "public, max-age=31536000, immutable"; try_files $uri =404; }
  location ~* \.(?:js|css|woff2|png|jpe?g|webp|gif|svg|ico)$ { add_header Cache-Control "public, max-age=31536000, immutable"; try_files $uri =404; }

  # SPA fallback
  location / { try_files $uri /index.html; }

  # API proxy paths (mirror existing prod config expectations)
  location /api/ {
    limit_req zone=api_rl burst=15 nodelay;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_http_version 1.1;
    proxy_buffering off;
    proxy_read_timeout 300s;
    proxy_send_timeout 300s;
    proxy_pass http://backend:8000$request_uri;
  }
  location /chat/stream {
    limit_conn sse_conn 1;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_http_version 1.1;
    proxy_buffering off;
    proxy_read_timeout 300s;
    proxy_send_timeout 300s;
    proxy_pass http://backend:8000$request_uri;
  }
  location /llm/ { proxy_pass http://backend:8000$request_uri; }
  location /ready { proxy_pass http://backend:8000/ready; }
  location /metrics { proxy_pass http://backend:8000/metrics; }

  # Status rewrite + CORS (optional; replicate if status endpoints used)
  location /api/status/ {
    rewrite ^/api/status/(.*)$ /status/$1 break;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_pass http://backend:8000;
    if ($cors_ok) { add_header Access-Control-Allow-Origin $http_origin always; add_header Vary Origin always; }
    if ($request_method = OPTIONS) { add_header Access-Control-Allow-Origin $http_origin always; add_header Access-Control-Allow-Methods "GET,OPTIONS" always; add_header Access-Control-Allow-Headers "Content-Type" always; return 204; }
    add_header Cache-Control "no-store, no-cache, must-revalidate, max-age=0" always;
  }
}
