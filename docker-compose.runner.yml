version: "3.9"

services:
  gh-runner:
    env_file:
      - .env.runner
    image: ghcr.io/actions/actions-runner:latest
    container_name: gh-runner
    restart: unless-stopped

    # Allow workflow steps to run docker commands on the host
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - ./runner-data:/runner
      - ./runner-entrypoint.sh:/entrypoint.sh:ro

    # Add runner to host's docker group (GID varies by system)
    # Most common GIDs: 999 (Ubuntu/Debian), 998 (RHEL/CentOS), 0 (root - Windows Docker Desktop)
    group_add:
      - "0" # Add root group for Docker socket access on Windows/Docker Desktop

    # Connect to infra_net to access portfolio-backend, portfolio-nginx, cloudflared
    networks:
      - infra_net

    # All environment variables loaded from .env.runner (not committed)
    # No environment: section - env_file takes precedence

    entrypoint: ["/bin/bash", "/entrypoint.sh"]

    # Health check: verify runner process is alive
    healthcheck:
      test: ["CMD-SHELL", "pgrep -f 'Runner.Listener' > /dev/null || exit 1"]
      interval: 60s
      timeout: 10s
      retries: 3
      start_period: 30s

# Use existing infra_net network to access production services
networks:
  infra_net:
    external: true
